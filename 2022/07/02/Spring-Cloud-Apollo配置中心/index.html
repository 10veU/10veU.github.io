<!--
	作者：Sariay
	时间：2018-09-25
	描述：There may be a bug, but don't worry, QiLing(器灵) says that it can work normally!
-->
<!DOCTYPE html>
<html class="html-loading">
		

<head><meta name="generator" content="Hexo 3.9.0">
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <title>
    
      Spring Cloud Apollo配置中心 | null
    
  </title>
  <meta name="author" content="XiaoJie Wang">
  <meta name="keywords" content>
  <meta name="description" content>
	<!-- favicon -->
  <link rel="shortcut icon" href="/img/Mr-Wang-facvion.ico">

  <!-- css -->
  <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/Annie.css">
  
  <!-- jquery -->
	<script src="/js/jquery.min.js"></script>

  <!-- leancloud -->
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
<script src="/js/leancloud.js"></script>
</head>
	<body>
		<!-- Preloader -->

	<div id="preloader">
		<div class="pre-container">
			
				<div class="spinner">
					<div class="double-bounce1"></div>
					<div class="double-bounce2"></div>
				</div>
						
		</div>
	</div>


<!-- header -->
<header class="fixbackground" data-img-mode="random" data-normal-src="/" data-random-max="110" data-random-src="https://10veu.github.io/Random-img/">
	<div class="mask">
		<!-- Logo and navigation -->
		<div class="h-header">
			<div id="logo">
				<a href="/">
					
						
					
				</a>
			</div>
			
			<div id="navigation-show">
				<ul>
	
		<li class="menu-home">
			<a href="/" class="menu-item-home">主页</a>
		</li>
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive">归档</a>
		</li>
	
		<li class="menu-categories">
			<a href="/categories" class="menu-item-categories">分类</a>
		</li>
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags">标签</a>
		</li>
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about">关于</a>
		</li>
	
		<li class="menu-gallery">
			<a href="/gallery" class="menu-item-gallery">相册</a>
		</li>
	

	
		<li class="menu-search">
			<a href="javascript:;" class="popup-trigger">搜索</a>
		</li>
	
</ul>
			</div>				
		</div>

		<!-- motto -->
		<div class="h-body">	
			
				<p class="motto"></p>
			
		</div>
		
		<!-- others: such as time... -->			
		<div class="h-footer">
			<a href="javascript:;" id="read-more"><i class="fa fa-angle-double-down" aria-hidden="true"></i>
			</a>

			
				<!-- 
	This is only a demo, please go to "https://time.is" to set your city time! 
-->
<style type="text/css">
	.header-date {
		font-size: 1.6rem;
		color: #fff;
		position: absolute;
		bottom: 5px;
		right: 1rem;
		writing-mode: tb-rl;
	}	
	
	.header-date a {
		border-bottom: none;
	}

	@media only screen and (max-width: 768 ) {
		.header-date {
			font-size: 1rem;
		}			
	}
</style>
<div class="header-date">
	<a href="https://time.is/Beijing" id="time_is_link" rel="nofollow" ></a>
	<span id="Beijing_z43d"></span>
</div>
<script src="//widget.time.is/zh.js"></script>
<script>
	time_is_widget.init({
		Beijing_z43d:{
			template:"DATE", 
			date_format:"year年 monthname dnum日"
		}
	});
</script>
			
		</div>
	</div>
</header>

<div id="navigation-hide">
	<!-- Progress bar -->
	<div id="progress-bar"></div>

	<!-- Progress percent -->
	<div id="progress-percentage"><h1>0.0%</h1></div>

	<div class="toc-switch"><span class="switch-button">目录</span></div>

	<!-- Page title -->
	<p>
		
			当前文章&nbsp;:&nbsp;《Spring Cloud Apollo配置中心》
		
	</p>

	<!-- Nav trigger for navigation-H-->
	<a class="nav-trigger"><span></span></a>
</div>

<!-- Navigation in div(id="navigation-H") -->
<nav class="nav-container" id="cd-nav">
	<div class="nav-header">
		<h3>Navigation</h3>
		<a href="javascript:;" class="nav-close"></a>
	</div>
	<div class="nav-body">
		<ul>
	
		<li class="menu-home">
			<a href="/" class="menu-item-home">主页</a>
		</li>
	
		<li class="menu-archive">
			<a href="/archives" class="menu-item-archive">归档</a>
		</li>
	
		<li class="menu-categories">
			<a href="/categories" class="menu-item-categories">分类</a>
		</li>
	
		<li class="menu-tags">
			<a href="/tags" class="menu-item-tags">标签</a>
		</li>
	
		<li class="menu-about">
			<a href="/about" class="menu-item-about">关于</a>
		</li>
	
		<li class="menu-gallery">
			<a href="/gallery" class="menu-item-gallery">相册</a>
		</li>
	

	
		<li class="menu-search">
			<a href="javascript:;" class="popup-trigger">搜索</a>
		</li>
	
</ul>
	</div>
	<div class="nav-footer">
		<ul>
	
		<li>
			<a href="https://github.com/10veU" target="_blank">
				<i class="fa fa-github"></i>
			</a>
		</li>
	
		<li>
			<a href="https://weibo.com/5559797464/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank">
				<i class="fa fa-weibo"></i>
			</a>
		</li>
	
		<li>
			<a href="/img/wechat.jpg" target="_blank">
				<i class="fa fa-wechat"></i>
			</a>
		</li>
	
		<li>
			<a href="tencent://message/?menu=yes&uin=514084647&websitename=im.qq.com" target="_blank">
				<i class="fa fa-qq"></i>
			</a>
		</li>
	
		<li>
			<a href="mailto:xiaojie_wangxj@163.com" target="_blank">
				<i class="fa fa-envelope"></i>
			</a>
		</li>
	
		<li>
			<a href="/atom.xml" target="_blank">
				<i class="fa fa-rss"></i>
			</a>
		</li>
			
</ul>

	</div>
</nav>
			
		<!--main-->
		<main>
			<!--
	时间：2018-11-17
	描述：
		插件名称：katelog.min.js
		插件作者：KELEN
		插件来源: https://github.com/KELEN/katelog
-->

	
		<div class="layout-toc">
			<div id="layout-toc">
				<div class="k-catelog-list" id="catelog-list" data-title="文章目录"></div>
			</div>
		</div>

		
		<script src="/plugin/toc/katelog.min.js"></script>

		
	 

<div class="layout-post">
	<div id="layout-post">
	<div class="article-title">
		<i class="fa fa-paper-plane-o" aria-hidden="true"></i>
		
	<a href="/2022/07/02/Spring-Cloud-Apollo配置中心/" itemprop="url">
		Spring Cloud Apollo配置中心
	</a>

	</div>

	<div class="article-meta">
		<span>
			<i class="fa fa-calendar"></i>
			


	发布于

	<a href="/2022/07/02/Spring-Cloud-Apollo配置中心/" itemprop="url">
		<time datetime="2022-07-02T20:46:26.000Z" itemprop="datePublished">
	  		2022-07-02
	  </time>
	</a>
	&nbsp;





			




	更新于

	<a href="/2022/07/02/Spring-Cloud-Apollo配置中心/" itemprop="url">
		<time datetime="2022-07-02T20:46:26.000Z" itemprop="dateUpdated">
	  		2024-06-22
	  </time>
	</a> 



		</span>
		<span>
			<i class="fa fa-tags"></i>
			
	
		<a href="/tags/微服务/" class=" ">
			微服务
		</a>
	
		<a href="/tags/Spring-Cloud/" class=" ">
			Spring Cloud
		</a>
	
		<a href="/tags/配置中心/" class=" ">
			配置中心
		</a>
	
		
		</span>
		
		

	
    <span class="leancloud_visitors" id="/2022/07/02/Spring-Cloud-Apollo配置中心/_visitors" data-url="/2022/07/02/Spring-Cloud-Apollo配置中心/" data-title="Spring Cloud Apollo配置中心">
       	<i class="fa fa-eye"></i>
       	热度
        <i class="leancloud_visitors_count" id="leancloud_visitors_count">0</i>
    </span>
    



	
    <span class="leancloud_likes" id="/2022/07/02/Spring-Cloud-Apollo配置中心/_likes" data-url="/2022/07/02/Spring-Cloud-Apollo配置中心/" data-title="Spring Cloud Apollo配置中心" rel="unlike">
        <i class="fa fa-heart"></i>
        喜欢
        <i class="leancloud_likes_count" id="leancloud_likes_count">0</i>
    </span>

	</div>

	<div class="article-content" id="article-content">
		<h1 id="Spring-Cloud-Apollo配置中心"><a href="#Spring-Cloud-Apollo配置中心" class="headerlink" title="Spring Cloud Apollo配置中心"></a>Spring Cloud Apollo配置中心</h1><p><img src="logo-apollo.png" alt></p>
<h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><p>随着程序功能的日益复杂，程序的配置日益增多：各种功能的开关、参数的配置、服务器的地址……</p>
<p>对程序配置的期望值也越来越高：配置修改后实时生效，灰度发布，分环境、分集群管理配置，完善的权限、审核机制……</p>
<p>在这样的大环境下，传统的通过配置文件、数据库等方式已经越来越无法满足开发人员对配置管理的需求。</p>
<p>Apollo配置中心应运而生！</p>
<h2 id="2-Apollo简介"><a href="#2-Apollo简介" class="headerlink" title="2. Apollo简介"></a>2. Apollo简介</h2><p>Apollo（阿波罗）是一款可靠的分布式配置管理中心，诞生于携程框架研发部，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</p>
<p>Apollo支持4个维度管理Key-Value格式的配置：</p>
<ol>
<li>application (应用)</li>
<li>environment (环境)</li>
<li>cluster (集群)</li>
<li>namespace (命名空间)</li>
</ol>
<p>同时，Apollo基于开源模式开发，开源地址：<a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo</a></p>
<h2 id="3-Apollo-核心概念"><a href="#3-Apollo-核心概念" class="headerlink" title="3. Apollo 核心概念"></a>3. Apollo 核心概念</h2><h3 id="application-应用"><a href="#application-应用" class="headerlink" title="application (应用)"></a>application (应用)</h3><ul>
<li>这个很好理解，就是实际使用配置的应用，Apollo客户端在运行时需要知道当前应用是谁，从而可以去获取对应的配置</li>
<li>每个应用都需要有唯一的身份标识 – appId，我们认为应用身份是跟着代码走的，所以需要在代码中配置，具体信息请参见<a href="https://www.apolloconfig.com/#/zh/usage/java-sdk-user-guide" target="_blank" rel="noopener">Java客户端使用指南</a>。</li>
</ul>
<h3 id="environment-（环境）"><a href="#environment-（环境）" class="headerlink" title="environment （环境）"></a>environment （环境）</h3><ul>
<li>配置对应的环境，Apollo客户端在运行时需要知道当前应用处于哪个环境，从而可以去获取应用的配置</li>
<li>我们认为环境和代码无关，同一份代码部署在不同的环境就应该能够获取到不同环境的配置</li>
<li>所以环境默认是通过读取机器上的配置（server.properties中的env属性）指定的，不过为了开发方便，我们也支持运行时通过System Property等指定，具体信息请参见<a href="https://www.apolloconfig.com/#/zh/usage/java-sdk-user-guide" target="_blank" rel="noopener">Java客户端使用指南</a>。</li>
</ul>
<h3 id="cluster-集群"><a href="#cluster-集群" class="headerlink" title="cluster (集群)"></a>cluster (集群)</h3><ul>
<li>一个应用下不同实例的分组，比如典型的可以按照数据中心分，把上海机房的应用实例分为一个集群，把北京机房的应用实例分为另一个集群。</li>
<li>对不同的cluster，同一个配置可以有不一样的值，如zookeeper地址。</li>
<li>集群默认是通过读取机器上的配置（server.properties中的idc属性）指定的，不过也支持运行时通过System Property指定，具体信息请参见<a href="https://www.apolloconfig.com/#/zh/usage/java-sdk-user-guide" target="_blank" rel="noopener">Java客户端使用指南</a>。</li>
</ul>
<h3 id="namespace-命名空间"><a href="#namespace-命名空间" class="headerlink" title="namespace (命名空间)"></a>namespace (命名空间)</h3><ul>
<li>一个应用下不同配置的分组，可以简单地把namespace类比为文件，不同类型的配置存放在不同的文件中，如数据库配置文件，RPC配置文件，应用自身的配置文件等</li>
<li>应用可以直接读取到公共组件的配置namespace，如DAL，RPC等</li>
<li>应用也可以通过继承公共组件的配置namespace来对公共组件的配置做调整，如DAL的初始数据库连接数</li>
</ul>
<h2 id="4-Apollo-特性"><a href="#4-Apollo-特性" class="headerlink" title="4. Apollo 特性"></a>4. Apollo 特性</h2><p>正是基于配置的特殊性，所以Apollo从设计之初就立志于成为一个有治理能力的配置发布平台，目前提供了以下的特性：</p>
<ul>
<li><strong>统一管理不同环境、不同集群的配置</strong><ul>
<li>Apollo提供了一个统一界面集中式管理不同环境（environment）、不同集群（cluster）、不同命名空间（namespace）的配置。</li>
<li>同一份代码部署在不同的集群，可以有不同的配置，比如zookeeper的地址等</li>
<li>通过命名空间（namespace）可以很方便地支持多个不同应用共享同一份配置，同时还允许应用对共享的配置进行覆盖</li>
</ul>
</li>
<li><strong>配置修改实时生效（热发布）</strong><ul>
<li>用户在Apollo修改完配置并发布后，客户端能实时（1秒）接收到最新的配置，并通知到应用程序</li>
</ul>
</li>
<li><strong>版本发布管理</strong><ul>
<li>所有的配置发布都有版本概念，从而可以方便地支持配置的回滚</li>
</ul>
</li>
<li><strong>灰度发布</strong><ul>
<li>支持配置的灰度发布，比如点了发布后，只对部分应用实例生效，等观察一段时间没问题后再推给所有应用实例</li>
</ul>
</li>
<li><strong>权限管理、发布审核、操作审计</strong><ul>
<li>应用和配置的管理都有完善的权限管理机制，对配置的管理还分为了编辑和发布两个环节，从而减少人为的错误。</li>
<li>所有的操作都有审计日志，可以方便地追踪问题</li>
</ul>
</li>
<li><strong>客户端配置信息监控</strong><ul>
<li>可以在界面上方便地看到配置在被哪些实例使用</li>
</ul>
</li>
<li><strong>提供Java和.Net原生客户端</strong><ul>
<li>提供了Java和.Net的原生客户端，方便应用集成</li>
<li>支持Spring Placeholder, Annotation和Spring Boot的ConfigurationProperties，方便应用使用（需要Spring 3.1.1+）</li>
<li>同时提供了Http接口，非Java和.Net应用也可以方便地使用</li>
</ul>
</li>
<li><strong>提供开放平台API</strong><ul>
<li>Apollo自身提供了比较完善的统一配置管理界面，支持多环境、多数据中心配置管理、权限、流程治理等特性。不过Apollo出于通用性考虑，不会对配置的修改做过多限制，只要符合基本的格式就能保存，不会针对不同的配置值进行针对性的校验，如数据库用户名、密码，Redis服务地址等</li>
<li>对于这类应用配置，Apollo支持应用方通过开放平台API在Apollo进行配置的修改和发布，并且具备完善的授权和权限控制</li>
</ul>
</li>
<li><strong>部署简单</strong><ul>
<li>配置中心作为基础服务，可用性要求非常高，这就要求Apollo对外部依赖尽可能地少</li>
<li>目前唯一的外部依赖是MySQL，所以部署非常简单，只要安装好Java和MySQL就可以让Apollo跑起来</li>
<li>Apollo还提供了打包脚本，一键就可以生成所有需要的安装包，并且支持自定义运行时参数</li>
</ul>
</li>
</ul>
<h2 id="5-Apollo总体设计"><a href="#5-Apollo总体设计" class="headerlink" title="5. Apollo总体设计"></a>5. Apollo总体设计</h2><blockquote>
<p>详见<a href="https://www.apolloconfig.com/#/zh/design/apollo-design" target="_blank" rel="noopener">Apollo配置中心设计 (apolloconfig.com)</a></p>
</blockquote>
<h2 id="6-环境准备"><a href="#6-环境准备" class="headerlink" title="6. 环境准备"></a>6. 环境准备</h2><h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><ul>
<li>Apollo服务端：1.8+</li>
<li>Apollo客户端：1.8+</li>
</ul>
<blockquote>
<p>如需运行在 Java 1.7 运行时环境，请使用 1.x 版本的 apollo 客户端，如 1.9.1</p>
</blockquote>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><ul>
<li>版本要求：5.6.5+</li>
</ul>
<blockquote>
<p>Apollo的表结构对<code>timestamp</code>使用了多个default声明，所以需要5.6.5以上版本。</p>
</blockquote>
<h3 id="下载Quick-Start安装包"><a href="#下载Quick-Start安装包" class="headerlink" title="下载Quick Start安装包"></a>下载Quick Start安装包</h3><p><code>Apollo</code>准备好了一个<code>Quick Start</code>安装包，只需要下载到本地，就可以直接使用，免去了编译、打包过程。</p>
<p>安装包共<code>50M</code>，如果访问<code>Github</code>网速不给力的话，可以从百度网盘下载。</p>
<ol>
<li>从<code>GitHub</code>下载<ul>
<li><code>checkout</code>或下载<a href="https://github.com/nobodyiam/apollo-build-scripts" target="_blank" rel="noopener">apollo-build-scripts项目</a></li>
<li>由于<code>Quick Start</code>项目比较大，所以放在了另外的<code>repository</code>，请注意项目地址<ul>
<li><a href="https://github.com/nobodyiam/apollo-build-scripts" target="_blank" rel="noopener">https://github.com/nobodyiam/apollo-build-scripts</a></li>
</ul>
</li>
</ul>
</li>
<li>从百度网盘下载<ul>
<li>通过<a href="https://pan.baidu.com/s/1Ieelw6y3adECgktO0ea0Gg" target="_blank" rel="noopener">网盘链接</a>下载，提取码: <code>9wwe</code></li>
<li>下载到本地后，在本地解压<code>apollo-quick-start.zip</code></li>
</ul>
</li>
<li>为啥安装包要<code>58M</code>这么大？<ul>
<li>因为这是一个可以自启动的<code>jar</code>包，里面包含了所有依赖<code>jar</code>包以及一个内置的<code>tomcat</code>容器</li>
</ul>
</li>
</ol>
<h2 id="7-安装-Apollo"><a href="#7-安装-Apollo" class="headerlink" title="7. 安装 Apollo"></a>7. 安装 Apollo</h2><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p><code>Apollo</code>服务端共需要两个数据库：<code>ApolloPortalDB</code>和<code>ApolloConfigDB</code>，我们把数据库、表的创建和样例数据都分别准备了sql文件，只需要导入数据库即可。</p>
<blockquote>
<p>❗注意：如果你本地已经创建过Apollo数据库，请注意备份数据。我们准备的sql文件会清空Apollo相关的表。</p>
</blockquote>
<h4 id="创建ApolloPortalDB"><a href="#创建ApolloPortalDB" class="headerlink" title="创建ApolloPortalDB"></a>创建ApolloPortalDB</h4><p>通过各种MySQL客户端导入<a href="https://github.com/nobodyiam/apollo-build-scripts/blob/master/sql/apolloportaldb.sql" target="_blank" rel="noopener">sql/apolloportaldb.sql</a>即可。</p>
<h4 id="创建ApolloConfigDB"><a href="#创建ApolloConfigDB" class="headerlink" title="创建ApolloConfigDB"></a>创建ApolloConfigDB</h4><p>通过各种MySQL客户端导入<a href="https://github.com/nobodyiam/apollo-build-scripts/blob/master/sql/apolloconfigdb.sql" target="_blank" rel="noopener">sql/apolloconfigdb.sql</a>即可。</p>
<h3 id="配置数据库连接信息"><a href="#配置数据库连接信息" class="headerlink" title="配置数据库连接信息"></a>配置数据库连接信息</h3><p>Apollo服务端需要知道如何连接到你前面创建的数据库，所以需要编辑<a href="https://github.com/nobodyiam/apollo-build-scripts/blob/master/demo.sh" target="_blank" rel="noopener">demo.sh</a>，修改ApolloPortalDB和ApolloConfigDB相关的数据库连接串信息。</p>
<blockquote>
<p>注意：填入的用户需要具备对ApolloPortalDB和ApolloConfigDB数据的读写权限。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">apollo config db info</span></span><br><span class="line">apollo_config_db_url="jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai"</span><br><span class="line">apollo_config_db_username=用户名</span><br><span class="line">apollo_config_db_password=密码（如果没有密码，留空即可）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> apollo portal db info</span></span><br><span class="line">apollo_portal_db_url="jdbc:mysql://localhost:3306/ApolloPortalDB?characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai"</span><br><span class="line">apollo_portal_db_username=用户名</span><br><span class="line">apollo_portal_db_password=密码（如果没有密码，留空即可）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>❗注意：不要修改demo.sh的其它部分</p>
</blockquote>
<h2 id="8-启动Apollo配置中心（搭建服务端）"><a href="#8-启动Apollo配置中心（搭建服务端）" class="headerlink" title="8. 启动Apollo配置中心（搭建服务端）"></a>8. 启动Apollo配置中心（搭建服务端）</h2><h3 id="确保端口未被占用"><a href="#确保端口未被占用" class="headerlink" title="确保端口未被占用"></a>确保端口未被占用</h3><p>Quick Start脚本会在本地启动3个服务，分别使用<code>8070, 8080, 8090</code>端口，请确保这3个端口当前没有被使用。</p>
<h3 id="执行启动脚本"><a href="#执行启动脚本" class="headerlink" title="执行启动脚本"></a>执行启动脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./demo.sh start</span><br></pre></td></tr></table></figure>

<p>当看到如下输出后，就说明启动成功了！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">==== starting service ====</span><br><span class="line">Service logging file is ./service/apollo-service.log</span><br><span class="line">Started [10768]</span><br><span class="line">Waiting for config service startup.......</span><br><span class="line">Config service started. You may visit http://localhost:8080 for service status now!</span><br><span class="line">Waiting for admin service startup....</span><br><span class="line">Admin service started</span><br><span class="line">==== starting portal ====</span><br><span class="line">Portal logging file is ./portal/apollo-portal.log</span><br><span class="line">Started [10846]</span><br><span class="line">Waiting for portal startup......</span><br><span class="line">Portal started. You can visit http://localhost:8070 now!</span><br></pre></td></tr></table></figure>

<p><img src="apollo-1.png" alt></p>
<h3 id="异常排查"><a href="#异常排查" class="headerlink" title="异常排查"></a>异常排查</h3><p>如果启动遇到了异常，可以分别查看<code>service</code>和<code>portal</code>目录下的<code>log</code>文件排查问题。</p>
<blockquote>
<p>注：在启动apollo-configservice的过程中会在日志中输出eureka注册失败的信息，如<code>com.sun.jersey.api.client.ClientHandlerException: java.net.ConnectException: Connection refused</code>。需要注意的是，这个是预期的情况，因为apollo-configservice需要向Meta Server（它自己）注册服务，但是因为在启动过程中，自己还没起来，所以会报这个错。后面会进行重试的动作，所以等自己服务起来后就会注册正常了。</p>
</blockquote>
<p>访问：<a href="http://localhost:8070/" target="_blank" rel="noopener">http://localhost:8070/</a> <code>Quick Start</code> 集成了 <code>Spring Security</code>，输入用户名 <code>apollo</code>，密码 <code>admin</code> 后登录。</p>
<p><img src="apollo-2.png" alt></p>
<p>登录成功后，首页如下，<code>Apollo</code> 还提供了一个 <code>SampleApp</code> 样本案例供我们学习使用。</p>
<p><img src="apollo-3.png" alt></p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>点击对应的<code>创建应用</code>创建项目。</p>
<p><img src="apollo-4.png" alt></p>
<p>创建成功如下图所示</p>
<p><img src="apollo-5.png" alt></p>
<h2 id="9-使用Apollo配置中心（客户端接入服务端）"><a href="#9-使用Apollo配置中心（客户端接入服务端）" class="headerlink" title="9. 使用Apollo配置中心（客户端接入服务端）"></a>9. 使用Apollo配置中心（客户端接入服务端）</h2><p>下面通过最常用、便捷的方式，即基于 Spring Boot 的集成方式来接入服务端。</p>
<blockquote>
<p><a href="https://www.apolloconfig.com/#/zh/usage/java-sdk-user-guide?id=_3213-spring-boot集成方式（推荐）" target="_blank" rel="noopener">Java客户端使用指南 (apolloconfig.com)</a></p>
</blockquote>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ctrip.framework.apollo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apollo-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p><code>order-service03</code> 和 <code>order-service04</code> 的配置信息除端口外一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9093</span>  <span class="comment"># 端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">order-service</span>  <span class="comment"># 应用名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apollo相关配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必选配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">order-service</span>  <span class="comment"># 与Apollo配置中心中的AppId一致</span></span><br><span class="line"><span class="attr">apollo:</span></span><br><span class="line"><span class="attr">  meta:</span> <span class="attr">http://localhost:8080</span>  <span class="comment"># Apollo 中的 Eureka 注册中心地址</span></span><br><span class="line"><span class="comment"># 可选配置</span></span><br><span class="line">  <span class="comment">#cluster:  # 指定 Apollo 集群，相同集群实例使用对应集群的配置</span></span><br><span class="line">  <span class="comment">#cacheDir:  # 配置缓存目录，网络不可用时任然可提供配置服务</span></span><br><span class="line"><span class="attr">  bootstrap:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">DEV</span>  <span class="comment"># env支持以下几个值（大小写不敏感）：DEV/FAT/UAT/PRO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">order-service-dev</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义配置文件实体类"><a href="#自定义配置文件实体类" class="headerlink" title="自定义配置文件实体类"></a>自定义配置文件实体类</h3><p><code>order-service03</code> 和 <code>order-service04</code> 的实体类代码一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.demo.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mysql.host&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mysqlHost;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mysql.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer mysqlPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mysql.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mysqlUsername;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mysql.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mysqlPassword;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="控制层"><a href="#控制层" class="headerlink" title="控制层"></a>控制层</h3><p><code>order-service03</code> 和 <code>order-service04</code> 的控制层代码一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.demo.config.ConfigProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigProperties configProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/name"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configProperties.getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/mysql"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">getMySQLProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JDK9中的新特性，快速创建只读集合。</span></span><br><span class="line"><span class="comment">//        return Map.of("host", configProperties.getMysqlHost(),</span></span><br><span class="line"><span class="comment">//                "port", configProperties.getMysqlPort(),</span></span><br><span class="line"><span class="comment">//                "username", configProperties.getMysqlUsername(),</span></span><br><span class="line"><span class="comment">//                "password", configProperties.getMysqlPassword());</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"host"</span>,configProperties.getMysqlHost());</span><br><span class="line">        map.put(<span class="string">"port"</span>,configProperties.getMysqlPort());</span><br><span class="line">        map.put(<span class="string">"username"</span>,configProperties.getMysqlUsername());</span><br><span class="line">        map.put(<span class="string">"password"</span>,configProperties.getMysqlPassword());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><p>启动类需要添加 <code>@EnableApolloConfig</code> 注解。</p>
<p><code>order-service03</code> 和 <code>order-service04</code> 的启动类代码一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ctrip.framework.apollo.spring.annotation.EnableApolloConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableApolloConfig</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="修改配置信息前"><a href="#修改配置信息前" class="headerlink" title="修改配置信息前"></a>修改配置信息前</h4><p>访问：<a href="http://localhost:9090/name" target="_blank" rel="noopener">http://localhost:9090/name</a> 和 <a href="http://localhost:9091/name" target="_blank" rel="noopener">http://localhost:9091/name</a> 结果如下：</p>
<p><img src="apollo-7.png" alt></p>
<p><img src="apollo-8.png" alt></p>
<p>访问：<a href="http://localhost:9090/mysql" target="_blank" rel="noopener">http://localhost:9090/mysql</a> 和 <a href="http://localhost:9091/mysql" target="_blank" rel="noopener">http://localhost:9091/mysql</a> 结果如下：</p>
<p><img src="apollo-9.png" alt></p>
<p><img src="apollo-10.png" alt></p>
<h4 id="新增配置信息"><a href="#新增配置信息" class="headerlink" title="新增配置信息"></a>新增配置信息</h4><p>进入项目后点击右上角的 <code>新增配置</code>。</p>
<p><img src="apollo-11.png" alt></p>
<p>添加配置项 <code>name</code>、<code>mysql.username</code>、<code>mysql.password</code>。</p>
<p><img src="apollo-12.png" alt></p>
<p><img src="apollo-13.png" alt></p>
<p><img src="apollo-14.png" alt></p>
<h4 id="发布配置信息"><a href="#发布配置信息" class="headerlink" title="发布配置信息"></a>发布配置信息</h4><p>将刚才添加的配置信息批量发布至应用。</p>
<p><img src="apollo-15.png" alt></p>
<p><img src="apollo-16.png" alt></p>
<p><img src="apollo-17.png" alt></p>
<h4 id="修改配置信息后"><a href="#修改配置信息后" class="headerlink" title="修改配置信息后"></a>修改配置信息后</h4><p>控制台打印信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2022-06-29 16:43:04.222  INFO 69232 --- [Apollo-Config-1] c.f.a.s.p.AutoUpdateConfigChangeListener : Auto update apollo changed value successfully, new value: root_v2.0_password, key: mysql.password, beanName: configProperties, field: com.springcloud.demo.config.ConfigProperties.mysqlPassword</span><br><span class="line">2022-06-29 16:43:04.222  INFO 69232 --- [Apollo-Config-1] c.f.a.s.p.AutoUpdateConfigChangeListener : Auto update apollo changed value successfully, new value: order-service-v2.0, key: name, beanName: configProperties, field: com.springcloud.demo.config.ConfigProperties.name</span><br><span class="line">2022-06-29 16:43:04.222  INFO 69232 --- [Apollo-Config-1] c.f.a.s.p.AutoUpdateConfigChangeListener : Auto update apollo changed value successfully, new value: order-service-v2.0, key: name, beanName: configController, field: com.springcloud.demo.controller.ConfigController.name</span><br><span class="line">2022-06-29 16:43:04.222  INFO 69232 --- [Apollo-Config-1] c.f.a.s.p.AutoUpdateConfigChangeListener : Auto update apollo changed value successfully, new value: root_v2.0, key: mysql.username, beanName: configProperties, field: com.springcloud.demo.config.ConfigProperties.mysqlUsername</span><br></pre></td></tr></table></figure>

<p>访问：<a href="http://localhost:9090/name" target="_blank" rel="noopener">http://localhost:9090/name</a> 和 <a href="http://localhost:9091/name" target="_blank" rel="noopener">http://localhost:9091/name</a> 结果如下：</p>
<p><img src="apollo-18.png" alt></p>
<p><img src="apollo-19.png" alt></p>
<p>访问：<a href="http://localhost:9090/mysql" target="_blank" rel="noopener">http://localhost:9090/mysql</a> 和 <a href="http://localhost:9091/mysql" target="_blank" rel="noopener">http://localhost:9091/mysql</a> 结果如下：</p>
<p><img src="apollo-20.png" alt></p>
<p><img src="apollo-21.png" alt></p>
<p>以上只是 <code>Apollo</code> 的入门案例，后面我们会学习 <code>Apollo</code> 的更多高级玩法。</p>
<h2 id="10-服务端配置"><a href="#10-服务端配置" class="headerlink" title="10. 服务端配置"></a>10. 服务端配置</h2><blockquote>
<p><a href="https://www.apolloconfig.com/#/zh/deployment/distributed-deployment-guide?id=三、服务端配置说明" target="_blank" rel="noopener">分布式部署指南 (apolloconfig.com)</a></p>
</blockquote>
<h3 id="应用配置"><a href="#应用配置" class="headerlink" title="应用配置"></a>应用配置</h3><p>点击<code>管理员工具</code>下的<code>系统参数</code>菜单进入<code>应用配置</code>页面。</p>
<p><img src="apollo-22.png" alt></p>
<p>在<code>应用配置</code>页面通过<code>organizations</code>关键字查询部门信息，下图为默认信息。</p>
<p><img src="apollo-23.png" alt></p>
<p>在<code>value</code>一栏中添加自定义部门信息，点击保存，无特殊说明则修改完一分钟实时生效。</p>
<p><img src="apollo-24.png" alt></p>
<p>此时再去创建项目时，就可以选择我们刚才添加的部门了。</p>
<p><img src="apollo-25.png" alt></p>
<h3 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h3><p>点击<code>管理员工具</code>下的<code>用户管理</code>菜单进入用户管理页面。</p>
<p><img src="apollo-26.png" alt></p>
<p>填写用户信息，点击提交，无特殊说明则修改完一分钟实时生效。</p>
<p><img src="apollo-27.png" alt></p>
<p>此时再去创建项目时，就可以选择我们刚才添加的用户了。如下图，我们给 <code>product-service</code> 项目分配了负责人 <code>demo</code>，如果使用<code>demo</code>登录的话，则只能看到他自己负责的项目。而 <code>apollo</code> 用户是超级管理员所以可以看到所有项目。</p>
<p><img src="apollo-28.png" alt></p>
<h3 id="权限分配"><a href="#权限分配" class="headerlink" title="权限分配"></a>权限分配</h3><p>进入项目后点击右上角的<code>授权</code>按钮，进入<code>权限管理</code>页面。</p>
<p><img src="apollo-29.png" alt></p>
<p>可以给指定用户添加对该应用的<code>修改权</code>和<code>发布权</code>，比如 order-service 是 apollo 创建的，但是我授权给了 <code>demo</code>，<code>demo</code>再登录时也就可以操作这个项目了。</p>
<p><img src="apollo-30.png" alt></p>
<h3 id="删除应用（项目）"><a href="#删除应用（项目）" class="headerlink" title="删除应用（项目）"></a>删除应用（项目）</h3><p>点击<code>管理员工具</code>下的<code>删除应用、集群、AppNamespace</code>菜单进入对应页面。</p>
<p><img src="apollo-31.png" alt></p>
<p>在<code>删除应用</code>栏目中的 <code>AppId</code> 处填写应用 id 先进行查询，查询到应用后点击<code>删除应用</code>即可。</p>
<p><img src="apollo-32.png" alt></p>
<h2 id="11-配置管理"><a href="#11-配置管理" class="headerlink" title="11. 配置管理"></a>11. 配置管理</h2><blockquote>
<p>演示如何增改删配置信息，以及如何添加 <code>Namespace</code>。</p>
</blockquote>
<h3 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h3><p>进入项目后点击右上角的 <code>新增配置</code>。</p>
<p><img src="apollo-33.png" alt></p>
<p>添加配置项信息，点击提交即可，刚添加的配置信息处于未发布状态。</p>
<p><img src="apollo-34.png" alt></p>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><p>点击对应配置项的修改按钮。</p>
<p><img src="apollo-35.png" alt>修改配置信息，也可填写修改说明，点击提交即可，更新后的信息如需生效要重新发布。</p>
<p><img src="apollo-36.png" alt></p>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><p>点击发布按钮，就可以发布</p>
<p><img src="apollo-37.png" alt></p>
<p>发布确认</p>
<p><img src="apollo-38.png" alt></p>
<p>发布成功后，发布状态已设置为已发布</p>
<p><img src="apollo-39.png" alt></p>
<h3 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h3><p>回滚代表恢复至上一次的发布状态，比如刚刚发布的值是 <code>order-service-2.0</code>，回滚以后会恢复至上一次发布的 <code>order-service</code>。</p>
<p><img src="apollo-40.png" alt></p>
<p>确认回滚</p>
<p><img src="apollo-41.png" alt></p>
<h3 id="删除配置"><a href="#删除配置" class="headerlink" title="删除配置"></a>删除配置</h3><p>点击对应配置项的删除按钮。</p>
<p><img src="apollo-42.png" alt></p>
<p>删除配置信息后如需生效要重新发布。</p>
<p><img src="apollo-43.png" alt><img src="apollo-44.png" alt></p>
<h3 id="添加Namespace"><a href="#添加Namespace" class="headerlink" title="添加Namespace"></a>添加Namespace</h3><p>如果配置项过多的情况下，可以通过 <code>Namespace</code> 来进行管理，<code>Namespace</code> 就相当于一份配置文件。</p>
<p>进入项目后点击左下角<code>添加Namespace</code>。</p>
<p><img src="apollo-45.png" alt></p>
<p>选择<code>创建Namespace</code>，类型这里需要说明一下：</p>
<ul>
<li><code>public</code>：公共配置，其他应用也可以使用；</li>
<li><code>private</code>：私有配置，仅限本应用使用。</li>
</ul>
<p><img src="apollo-46.png" alt></p>
<p>可以通过<code>文本</code>的方式添加多个配置项。</p>
<p><img src="apollo-47.png" alt></p>
<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p>客户端配置文件信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9093</span>  <span class="comment"># 端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">order-service</span>  <span class="comment"># 应用名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apollo相关配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必选配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line">  <span class="comment">#id: order-service  # 与Apollo配置中心中的AppId一致</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">demo-service</span>  <span class="comment"># 与Apollo配置中心中的AppId一致</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apollo:</span></span><br><span class="line"><span class="attr">  meta:</span> <span class="attr">http://localhost:8080</span>  <span class="comment"># Apollo 中的 Eureka 注册中心地址</span></span><br><span class="line"><span class="comment"># 可选配置</span></span><br><span class="line">  <span class="comment">#cluster:  # 指定 Apollo 集群，相同集群实例使用对应集群的配置</span></span><br><span class="line">  <span class="comment">#cacheDir:  # 配置缓存目录，网络不可用时任然可提供配置服务</span></span><br><span class="line"><span class="attr">  bootstrap:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">DEV</span>  <span class="comment"># env支持以下几个值（大小写不敏感）：DEV/FAT/UAT/PRO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">order-service-dev</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<h5 id="注解方式"><a href="#注解方式" class="headerlink" title="注解方式"></a>注解方式</h5><p>在启动类或配置类中添加 <code>@EnableApolloConfig({&quot;application&quot;, &quot;application-rabbitmq&quot;})</code> 注解并指定 Namespace，就可以直接使用 Spring 的 <code>@Value</code> 注解来获取配置信息，<code>${}</code> 中对应 Apollo 中的 key，<code>:</code>后跟默认值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.demo.config.ConfigProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigProperties configProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;rabbitmq.host:&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;rabbitmq.port:&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;rabbitmq.username:rabbitmq&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;rabbitmq.password:rabbitmq&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/name"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configProperties.getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/mysql"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">getMySQLProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JDK9中的新特性，快速创建只读集合。</span></span><br><span class="line"><span class="comment">//        return Map.of("host", configProperties.getMysqlHost(),</span></span><br><span class="line"><span class="comment">//                "port", configProperties.getMysqlPort(),</span></span><br><span class="line"><span class="comment">//                "username", configProperties.getMysqlUsername(),</span></span><br><span class="line"><span class="comment">//                "password", configProperties.getMysqlPassword());</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"host"</span>,configProperties.getMysqlHost());</span><br><span class="line">        map.put(<span class="string">"port"</span>,configProperties.getMysqlPort());</span><br><span class="line">        map.put(<span class="string">"username"</span>,configProperties.getMysqlUsername());</span><br><span class="line">        map.put(<span class="string">"password"</span>,configProperties.getMysqlPassword());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/mq"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">getRabbitMQProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JDK9中的新特性，快速创建只读集合。</span></span><br><span class="line"><span class="comment">//        return Map.of("host", configProperties.getMysqlHost(),</span></span><br><span class="line"><span class="comment">//                "port", configProperties.getMysqlPort(),</span></span><br><span class="line"><span class="comment">//                "username", configProperties.getMysqlUsername(),</span></span><br><span class="line"><span class="comment">//                "password", configProperties.getMysqlPassword());</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"host"</span>,host);</span><br><span class="line">        map.put(<span class="string">"port"</span>,port);</span><br><span class="line">        map.put(<span class="string">"username"</span>,username);</span><br><span class="line">        map.put(<span class="string">"password"</span>,password);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：<a href="http://localhost:9093/mq" target="_blank" rel="noopener">http://localhost:9093/mq</a> 结果如下：</p>
<p><img src="apollo-48.png" alt></p>
<h5 id="API方式"><a href="#API方式" class="headerlink" title="API方式"></a>API方式</h5><p>我们可以通过以下代码读取 Apollo 中的配置信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ctrip.framework.apollo.Config;</span><br><span class="line"><span class="keyword">import</span> com.ctrip.framework.apollo.ConfigService;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.demo.config.ConfigProperties;</span><br><span class="line"><span class="keyword">import</span> org.checkerframework.checker.units.qual.A;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigProperties configProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/name"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configProperties.getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/mysql"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">getMySQLProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JDK9中的新特性，快速创建只读集合。</span></span><br><span class="line"><span class="comment">//        return Map.of("host", configProperties.getMysqlHost(),</span></span><br><span class="line"><span class="comment">//                "port", configProperties.getMysqlPort(),</span></span><br><span class="line"><span class="comment">//                "username", configProperties.getMysqlUsername(),</span></span><br><span class="line"><span class="comment">//                "password", configProperties.getMysqlPassword());</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"host"</span>,configProperties.getMysqlHost());</span><br><span class="line">        map.put(<span class="string">"port"</span>,configProperties.getMysqlPort());</span><br><span class="line">        map.put(<span class="string">"username"</span>,configProperties.getMysqlUsername());</span><br><span class="line">        map.put(<span class="string">"password"</span>,configProperties.getMysqlPassword());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/mq"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">getRabbitMQProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ConfigService.getAppConfig(); // 读取默认 Namespace</span></span><br><span class="line">        <span class="comment">// 读取指定 Namespace</span></span><br><span class="line">        Config config = ConfigService.getConfig(<span class="string">"application-rabbitmq"</span>);</span><br><span class="line">        <span class="comment">// 获取配置信息，第一个参数为配置项的 key，第二个参数为默认值（读取不到配置就会使用默认值，建议都加上默认值）</span></span><br><span class="line">        String host = config.getProperty(<span class="string">"rabbitmq.host"</span>, <span class="keyword">null</span>);</span><br><span class="line">        String port = config.getProperty(<span class="string">"rabbitmq.port"</span>, <span class="keyword">null</span>);</span><br><span class="line">        String username = config.getProperty(<span class="string">"rabbitmq.username"</span>, <span class="keyword">null</span>);</span><br><span class="line">        String password = config.getProperty(<span class="string">"rabbitmq.password"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// JDK9中的新特性，快速创建只读集合。</span></span><br><span class="line"><span class="comment">//        return Map.of("host", configProperties.getMysqlHost(),</span></span><br><span class="line"><span class="comment">//                "port", configProperties.getMysqlPort(),</span></span><br><span class="line"><span class="comment">//                "username", configProperties.getMysqlUsername(),</span></span><br><span class="line"><span class="comment">//                "password", configProperties.getMysqlPassword());</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"host"</span>,host);</span><br><span class="line">        map.put(<span class="string">"port"</span>,port);</span><br><span class="line">        map.put(<span class="string">"username"</span>,username);</span><br><span class="line">        map.put(<span class="string">"password"</span>,password);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问：<a href="http://localhost:9094/mq结果如下：" target="_blank" rel="noopener">http://localhost:9094/mq结果如下：</a></p>
<p><img src="apollo-49.png" alt></p>
<h3 id="公共配置"><a href="#公共配置" class="headerlink" title="公共配置"></a>公共配置</h3><p>刚才添加 <code>Namespace</code> 时我们选择的是 private 私有配置，仅限本项目使用，如果有一些配置我们所有项目都需要使用，可以通过公共配置实现。</p>
<h4 id="添加公共配置"><a href="#添加公共配置" class="headerlink" title="添加公共配置"></a>添加公共配置</h4><p>比如我们先创建一个公共项目 <code>common-service</code>。</p>
<p><img src="apollo-50.png" alt></p>
<p>然后创建公共的 Namespace。</p>
<p><img src="apollo-51.png" alt></p>
<p>添加配置信息提交并发布。</p>
<p><img src="apollo-52.png" alt></p>
<p>值得注意的是，公共配置信息是哪个项目创建的才拥有修改和删除的权力，其他项目只能选择关联和覆盖。</p>
<p><img src="apollo-53.png" alt></p>
<h4 id="关联公共配置"><a href="#关联公共配置" class="headerlink" title="关联公共配置"></a>关联公共配置</h4><p>让 <code>order-service</code> 项目关联 <code>common-service</code> 的公共配置信息。</p>
<p>进入项目后点击左下角<code>添加Namespace</code>，选择关联公共<code>Namespace</code>，添加刚才创建的公共<code>Namespace</code>。</p>
<p><img src="apollo-54.png" alt></p>
<p>关联成功以后在项目首页可以看到关联的配置信息，且只能选择覆盖此配置，不能删除和修改配置信息（可以删除Namespace）。或者直接在私有配置下配置同名的配置项，同名的私有配置会比公共配置优先级高。</p>
<p><img src="apollo-55.png" alt></p>
<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><h5 id="注解方式-1"><a href="#注解方式-1" class="headerlink" title="注解方式"></a>注解方式</h5><p>在启动类或配置类中添加 <code>@EnableApolloConfig({&quot;application&quot;, &quot;application-rabbitmq&quot;, &quot;DEMO.application-common&quot;})</code> 注解并指定 Namespace，就可以直接使用 Spring 的 <code>@Value</code> 注解来获取配置信息，<code>${}</code> 中对应 Apollo 中的 key，<code>:</code>后跟默认值。</p>
<p>访问：<a href="http://localhost:9093/common" target="_blank" rel="noopener">http://localhost:9093/common</a> 结果如下：</p>
<p><img src="apollo-56.png" alt></p>
<h5 id="API方式-1"><a href="#API方式-1" class="headerlink" title="API方式"></a>API方式</h5><p>可以通过以下的方式读取 Apollo 中的配置信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/common"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">getCommon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ConfigService.getAppConfig(); // 读取默认 Namespace</span></span><br><span class="line">        <span class="comment">// 读取指定 Namespace</span></span><br><span class="line">        Config config = ConfigService.getConfig(<span class="string">"DEMO.application-common"</span>);</span><br><span class="line">        <span class="comment">// 获取配置信息，第一个参数为配置项的 key，第二个参数为默认值（读取不到配置就会使用默认值，建议都加上默认值）</span></span><br><span class="line">        String commonName = config.getProperty(<span class="string">"commonName"</span>, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        Map&lt;Object, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"commonName"</span>,commonName);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>访问：<a href="http://localhost:9094/common" target="_blank" rel="noopener">http://localhost:9094/common</a> 结果如下：</p>
<p><img src="apollo-57.png" alt></p>
<h2 id="12-集群管理"><a href="#12-集群管理" class="headerlink" title="12. 集群管理"></a>12. 集群管理</h2><p>在有些特殊情况下，比如部署在 A 机房的应用连接的 MySQL 服务器地址和部署在 B 机房的应用连接的 MySQL 服务器地址不一样。在这种情况下，可以通过在 Apollo 创建不同的集群来解决。</p>
<h3 id="添加集群"><a href="#添加集群" class="headerlink" title="添加集群"></a>添加集群</h3><p>进入项目后点击左下角<code>添加集群</code>，比如添加 SHAOY（欧阳数据中心)。</p>
<p><img src="apollo-58.png" alt></p>
<h3 id="同步配置"><a href="#同步配置" class="headerlink" title="同步配置"></a>同步配置</h3><p>集群其实就是另一个环境而已，所有的操作和前面的都一样，这里就不再赘述。有一点需要说明一下，就是同步配置功能。</p>
<p>假设 <code>SHAOY</code> 这个集群的配置信息和默认集群的配置信息只有个别地方不一致，大部分都是一致的，我们挨个添加岂不是很浪费时间？</p>
<p>可以看到在 SHAOY 这个集群下的 <code>application-rabbitmq</code> 的 <code>Namespace</code> 中是没有任何配置项的。<code>Apollo</code> 给我们提供了一个同步配置的功能。通过同步配置功能，可以使多个环境、集群间的配置保持一致，需要注意的是，同步完之后需要发布后才会对应用生效。</p>
<p>既然是将默认集群环境的配置同步至 SHAOY 环境中，那就在默认环境中选择需要同步的 <code>Namespace</code>，点击同步配置按钮。</p>
<p><img src="apollo-59.png" alt></p>
<p>勾选需要同步的配置，选择要同步到哪个集群，然后点击下一步。</p>
<p><img src="apollo-60.png" alt></p>
<p>点击同步按钮以后配置将同步成功，同步完之后需要发布后才会对应用生效。</p>
<p><img src="apollo-61.png" alt></p>
<p>然后发布配置。</p>
<p><img src="apollo-62.png" alt></p>
<h3 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h3><p>配置文件中通过 <code>apollo.cluster</code> 指定集群名称。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9093</span>  <span class="comment"># 端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">order-service</span>  <span class="comment"># 应用名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apollo相关配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必选配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line">  <span class="comment">#id: order-service  # 与Apollo配置中心中的AppId一致</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">demo-service</span>  <span class="comment"># 与Apollo配置中心中的AppId一致</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apollo:</span></span><br><span class="line"><span class="attr">  meta:</span> <span class="attr">http://localhost:8080</span>  <span class="comment"># Apollo 中的 Eureka 注册中心地址</span></span><br><span class="line"><span class="comment"># 可选配置</span></span><br><span class="line"><span class="attr">  cluster:</span> <span class="string">SHAOY</span>  <span class="comment"># 指定 Apollo 集群，相同集群实例使用对应集群的配置</span></span><br><span class="line">  <span class="comment">#cacheDir:  # 配置缓存目录，网络不可用时任然可提供配置服务</span></span><br><span class="line"><span class="attr">  bootstrap:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">DEV</span>  <span class="comment"># env支持以下几个值（大小写不敏感）：DEV/FAT/UAT/PRO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">order-service-dev</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>之前的代码无需做任何改变，访问：<a href="http://localhost:9093/mq" target="_blank" rel="noopener">http://localhost:9093/mq</a> 结果如下：</p>
<p><img src="apollo-63.png" alt></p>
<h2 id="13-多环境部署方案"><a href="#13-多环境部署方案" class="headerlink" title="13. 多环境部署方案"></a>13. 多环境部署方案</h2><p>多环境部署方案我们在 <code>Linux</code> 环境下搭建，不再使用 <code>Quick Start</code> 脚本。</p>
<p>当项目要上线部署到生产环境时，项目的配置比如数据库、缓存、队列等服务器的地址都会发生改变，这时候就需要通过 <code>Apollo</code> 为生产环境添加配置。目前 <code>Apollo</code> 预先定义的环境为：</p>
<ul>
<li><strong>DEV</strong>：Development environment 开发环境，用于开发者调试使用；</li>
<li><strong>FAT</strong>：Feature Acceptance Test environment 功能验收测试环境，用于软件测试者测试使用；</li>
<li><strong>UAT</strong>：User Acceptance Test environment 用户验收测试环境（仿真环境），用于生产环境下的软件测试者测试使用</li>
<li><strong>PRO</strong>：Production environment 生产环境，最终上线环境。</li>
</ul>
<p><code>Apollo</code> 也支持自定义环境。具体方式可以参考官方文档：<a href="https://www.apolloconfig.com/#/zh/faq/common-issues-in-deployment-and-development-phase?id=_4-portal如何增加环境？" target="_blank" rel="noopener">部署&amp;开发遇到的常见问题 (apolloconfig.com)</a></p>
<p>这里我们要明确一些信息：</p>
<ul>
<li><code>Portal</code> 部署在生产环境的机房，通过它来直接管理 <code>FAT</code>、<code>UAT</code>、<code>PRO</code> 等环境的配置即可；</li>
<li><code>Config Service</code>、<code>Admin Service</code> 和 <code>ApolloConfigDB</code> 在每个环境都单独部署；</li>
<li>应用需要配置指定的环境，默认为 <code>DEV</code>。</li>
</ul>
<p>总结下来就是：一套 <code>Portal</code> 可以管理多个环境，但是每个环境都需要独立部署一套 <code>Config Service</code>、<code>Admin Service</code> 和 <code>ApolloConfigDB</code>。</p>
<h3 id="服务器地址说明"><a href="#服务器地址说明" class="headerlink" title="服务器地址说明"></a>服务器地址说明</h3><ul>
<li><code>101.133.158.45</code>  </li>
</ul>
<blockquote>
<p>apollo-portal，公共的 Portal</p>
<p>DEV 环境，独立部署一套 Config Service、Admin Service，使用公共的 Portal</p>
</blockquote>
<ul>
<li><code>101.43.13.48</code></li>
</ul>
<blockquote>
<p>PRO 环境，独立部署一套 Config Service、Admin Service，使用公共的 Portal</p>
</blockquote>
<h3 id="创建数据库-1"><a href="#创建数据库-1" class="headerlink" title="创建数据库"></a>创建数据库</h3><ul>
<li><p><code>101.133.158.45</code>运行 <code>apolloportaldb.sql</code> 文件和 <code>apolloconfigdb.sql</code> 文件。  </p>
</li>
<li><p><code>101.43.13.48</code> 运行 <code>apolloconfigdb.sql</code> 文件。</p>
</li>
</ul>
<p>​    最终结果如下：</p>
<p>​    <img src="apollo-64.png" alt></p>
<h3 id="调整服务端配置"><a href="#调整服务端配置" class="headerlink" title="调整服务端配置"></a>调整服务端配置</h3><p><code>Apollo</code> 自身的一些配置是放在数据库里面的，所以需要针对实际情况做一些调整。</p>
<p>配置项统一存储在 <code>ApolloPortalDB.ServerConfig</code> 表中，如下图，在③Value的地方添加环境即可，比如 <code>dev,pro</code>。</p>
<p><img src="apollo-65.png" alt></p>
<p>或者也可以通过<code>管理员工具 - 系统参数</code>页面进行配置，通过 <code>apollo.portal.envs</code> 关键字查询并进行设置，无特殊说明则修改完一分钟实时生效。</p>
<p><img src="apollo-66.png" alt></p>
<h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p>从<a href="https://github.com/ctripcorp/apollo/releases" target="_blank" rel="noopener">GitHub Release</a>页面下载最新版本的<code>apollo-configservice-x.x.x-github.zip</code>、<code>apollo-adminservice-x.x.x-github.zip</code>和<code>apollo-portal-x.x.x-github.zip</code>即可。本小节采用这种方式，可以省去本地打包的过程。</p>
<p>如果需要对 Apollo 做定制开发，也可以选择通过源码构建：<a href="https://www.apolloconfig.com/#/zh/deployment/distributed-deployment-guide?id=_2212-通过源码构建" target="_blank" rel="noopener">分布式部署指南 (apolloconfig.com) </a>，后面高可用环境的搭建我们就采用这种方式。</p>
<h3 id="配置数据库"><a href="#配置数据库" class="headerlink" title="配置数据库"></a>配置数据库</h3><p>Apollo 服务端需要知道如何连接到你前面创建的数据库，数据库连接串信息位于上一步下载的压缩包中的<code>config/application-github.properties</code>中。</p>
<h4 id="配置-apollo-portal-的数据库连接信息"><a href="#配置-apollo-portal-的数据库连接信息" class="headerlink" title="配置 apollo-portal 的数据库连接信息"></a>配置 apollo-portal 的数据库连接信息</h4><ol>
<li><p>先将 <code>apollo-portal-x.x.x-github.zip</code> 上传至<code>101.133.158.45</code>服务器上。</p>
</li>
<li><p>解压<code>apollo-portal-x.x.x-github.zip</code></p>
</li>
<li><p>打开<code>config</code>目录下的<code>application-github.properties</code>文件</p>
</li>
<li><p>填写正确的 <code>ApolloPortalDB</code> 数据库连接串信息，注意用户名和密码后面不要有空格！</p>
</li>
<li><p>修改完的效果如下：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># DataSource</span><br><span class="line">spring.datasource.url = jdbc:mysql://localhost:3306/ApolloPortalDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = root</span><br></pre></td></tr></table></figure>

<h4 id="配置-apollo-configservice-的数据库连接信息"><a href="#配置-apollo-configservice-的数据库连接信息" class="headerlink" title="配置 apollo-configservice 的数据库连接信息"></a>配置 apollo-configservice 的数据库连接信息</h4><ol>
<li><p>将 <code>apollo-configservice-x.x.x-github.zip</code> 上传至<code>101.43.13.48</code>和 <code>101.133.158.45</code></p>
</li>
<li><p>解压<code>apollo-configservice-x.x.x-github.zip</code></p>
</li>
<li><p>打开<code>config</code>目录下的<code>application-github.properties</code>文件</p>
</li>
<li><p>填写正确的 <code>ApolloConfigDB</code> 数据库连接串信息，注意用户名和密码后面不要有空格！</p>
</li>
<li><p>修改完的效果如下：</p>
</li>
</ol>
<p><code>101.43.13.48</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> DataSource</span></span><br><span class="line">spring.datasource.url = jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = root</span><br></pre></td></tr></table></figure>

<p><code>101.133.158.45</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> DataSource</span></span><br><span class="line">spring.datasource.url = jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = root</span><br></pre></td></tr></table></figure>

<h4 id="配置-apollo-adminservice-的数据库连接信息"><a href="#配置-apollo-adminservice-的数据库连接信息" class="headerlink" title="配置 apollo-adminservice 的数据库连接信息"></a>配置 apollo-adminservice 的数据库连接信息</h4><ol>
<li><p>将 <code>apollo-adminservice-x.x.x-github.zip</code> 上传至<code>101.43.13.48</code>和 <code>101.133.158.45</code></p>
</li>
<li><p>解压<code>apollo-adminservice-x.x.x-github.zip</code></p>
</li>
<li><p>打开<code>config</code>目录下的<code>application-github.properties</code>文件</p>
</li>
<li><p>填写正确的 <code>ApolloConfigDB</code> 数据库连接串信息，注意用户名和密码后面不要有空格！</p>
</li>
<li><p>修改完的效果如下：</p>
</li>
</ol>
<p><code>101.43.13.48</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># DataSource</span><br><span class="line">spring.datasource.url = jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = root</span><br></pre></td></tr></table></figure>

<p><code>101.133.158.45</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># DataSource</span><br><span class="line">spring.datasource.url = jdbc:mysql://localhost:3306/ApolloPortalDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = root</span><br></pre></td></tr></table></figure>

<h4 id="配置apollo-portal的meta-service信息"><a href="#配置apollo-portal的meta-service信息" class="headerlink" title="配置apollo-portal的meta service信息"></a>配置apollo-portal的meta service信息</h4><p><code>Apollo Portal</code> 需要在不同的环境访问不同的 <code>meta service</code>(<code>apollo-configservice</code>) 地址，所以我们需要在配置中提供这些信息。默认情况下，<code>meta service</code> 和 <code>config service</code> 是部署在同一个<code>JVM</code>进程，所以 <code>meta service</code> 的地址就是 <code>config service</code> 的地址。</p>
<blockquote>
<p>对于 1.6.0 及以上版本，可以通过 ApolloPortalDB.ServerConfig 中的配置项来配置 Meta Service 地址。</p>
</blockquote>
<h5 id="新版本配置方式"><a href="#新版本配置方式" class="headerlink" title="新版本配置方式"></a>新版本配置方式</h5><p>通过 <code>apollo.portal.meta.servers</code> 添加 <code>meta service</code>(<code>apollo-configservice</code>) 地址，类似以下方式，修改完需要重启生效。</p>
<p><img src="apollo-70.png" alt></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"DEV"</span>:<span class="string">"http://101.133.158.45:8080"</span>,</span><br><span class="line"> 	<span class="attr">"PRO"</span>:<span class="string">"http://101.43.13.48:8080"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="旧版本配置方式"><a href="#旧版本配置方式" class="headerlink" title="旧版本配置方式"></a>旧版本配置方式</h5><p>打开<code>apollo-portal-x.x.x-github.zip</code>中<code>config</code>目录下的<code>apollo-env.properties</code>文件。</p>
<p>假设 <code>DEV</code> 的 <code>apollo-configservice</code> 未绑定域名，地址是 <code>1.1.1.1:8080</code>，<code>FAT</code> 的 <code>apollo-configservice</code> 绑定了域名 <code>apollo.fat.xxx.com</code>，<code>UAT</code> 的 <code>apollo-configservice</code> 绑定了域名 <code>apollo.uat.xxx.com</code>，<code>PRO</code> 的 <code>apollo-configservice</code> 绑定了域名 <code>apollo.xxx.com</code>，那么可以如下修改各环境 <code>meta service</code> 服务地址，格式为<code>${env}.meta=http://${config-service-url:port}</code>，如果某个环境不需要，也可以直接删除对应的配置项，参考案例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dev.meta=http://1.1.1.1:8080</span><br><span class="line">fat.meta=http://apollo.fat.xxx.com</span><br><span class="line">uat.meta=http://apollo.uat.xxx.com</span><br><span class="line">pro.meta=http://apollo.xxx.com</span><br></pre></td></tr></table></figure>

<p>如果采用旧版本配置方式，本小节配置方案如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">local.meta=http://localhost:8080</span></span><br><span class="line">dev.meta=http://101.133.158.45:8080</span><br><span class="line"><span class="meta">#</span><span class="bash">fat.meta=http://fill-in-fat-meta-server:8080</span></span><br><span class="line"><span class="meta">#</span><span class="bash">uat.meta=http://fill-in-uat-meta-server:8080</span></span><br><span class="line"><span class="meta">#</span><span class="bash">lpt.meta=<span class="variable">$&#123;lpt_meta&#125;</span></span></span><br><span class="line">pro.meta=http://101.43.13.48:8080</span><br></pre></td></tr></table></figure>

<blockquote>
<p>除了通过<code>apollo-env.properties</code>方式配置 meta service 以外，apollo 也支持在运行时指定 meta service（优先级比<code>apollo-env.properties</code>高）：</p>
<p><strong>通过 Java System Property</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;$&#123;env&#125;_meta</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ul>
<li>可以通过 Java 的 System Property <code>${env}_meta</code>来指定</li>
<li>如<code>java -Ddev_meta=http://config-service-url -jar xxx.jar</code></li>
<li>也可以通过程序指定，如<code>System.setProperty(&quot;dev_meta&quot;, &quot;http://config-service-url&quot;);</code></li>
</ul>
<p><strong>通过操作系统的 System Environment</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;$&#123;ENV&#125;_META</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ul>
<li>如<code>DEV_META=http://config-service-url</code></li>
<li>注意 key 为全大写，且中间是<code>_</code>分隔</li>
</ul>
</blockquote>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>安装服务器都进入对应安装包的 <code>script</code> 目录，执行 <code>startup.sh</code> 文件。</p>
<p>启动顺序为</p>
<ul>
<li>101.133.158.45 首先启动 Portal，然后启动ConfigService 再启动 AdminService</li>
<li>101.43.13.48 启动 ConfigService 再启动 AdminService</li>
</ul>
<p>先访问：<a href="http://101.133.158.45:8080" target="_blank" rel="noopener">http://101.133.158.45:8080</a> 和 <a href="http://101.43.13.48:8080" target="_blank" rel="noopener">http://101.43.13.48:8080</a> 看看 Eureka 以及各服务是否正常启动，如下：</p>
<p><img src="apollo-67.png" alt></p>
<p><img src="apollo-68.png" alt></p>
<p>　再访问：<a href="http://101.133.158.45:8070" target="_blank" rel="noopener">http://101.133.158.45:8070</a> 输入 Apollo/admin 进行登录，点击案例项目 SampleApp 进入项目首页，看到多环境说明搭建成功，后续的操作就和之前讲的一样了，这里就不再过多赘述。</p>
<p><img src="apollo-69.png" alt></p>
<h2 id="14-高可用环境搭建"><a href="#14-高可用环境搭建" class="headerlink" title="14. 高可用环境搭建"></a>14. 高可用环境搭建</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="数据库高可用"><a href="#数据库高可用" class="headerlink" title="数据库高可用"></a>数据库高可用</h4><p>方案很多，比如双主结构、主从结构、异地备份等等，还可以选择第三方云数据库服务，让云服务厂商去保证数据库的高可用性，这样不仅比自己实现起来更可靠、更轻松，而且还方便管理等。</p>
<h4 id="AdminService-高可用"><a href="#AdminService-高可用" class="headerlink" title="AdminService 高可用"></a>AdminService 高可用</h4><p>在 <code>Apollo</code> 中所有的 <code>Admin Service</code> 都会注册到 <code>Eureka</code> 里，所以我们只需要配置多台 <code>AdminService</code>，数据库采用同一套即可。</p>
<h4 id="ConfigService高可用"><a href="#ConfigService高可用" class="headerlink" title="ConfigService高可用"></a>ConfigService高可用</h4><p>在 <code>Apollo</code> 的设计中每个 <code>ConfigService</code> 也是一个 <code>Euerka</code> 的注册中心，所以保证 <code>ConfigService</code> 高可用的前提是保证 <code>Eureka</code> 的高可用，<code>Eureka</code> 的高可用实际上就是将自己作为服务向其他服务注册中心注册自己，这样就可以形成一组互相注册的服务注册中心，以实现服务清单的互相同步，达到高可用的效果。</p>
<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>再来一台机器 <code>101.43.13.49</code> 然后将 <code>apollo-configservice-x.x.x-github.zip</code> 和 <code>apollo-adminservice-x.x.x-github.zip</code> 上传至该机器，解压以后都配置 102 机器的数据库，我们搭建一个 DEV 的高可用环境。</p>
<h4 id="配置数据库-1"><a href="#配置数据库-1" class="headerlink" title="配置数据库"></a>配置数据库</h4><ol>
<li><p>将 ConfigService 和 AdminService 上传至 <code>101.43.13.49</code></p>
</li>
<li><p>解压</p>
</li>
<li><p>打开<code>config</code>目录下的<code>application-github.properties</code>文件</p>
</li>
<li><p>填写正确的 <code>ApolloConfigDB</code> 数据库连接串信息，注意用户名和密码后面不要有空格！</p>
</li>
<li><p>修改完的效果如下：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># DataSource</span><br><span class="line">spring.datasource.url = jdbc:mysql://101.43.13.48:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">spring.datasource.username = root</span><br><span class="line">spring.datasource.password = root</span><br></pre></td></tr></table></figure>

<h4 id="调整服务端配置-1"><a href="#调整服务端配置-1" class="headerlink" title="调整服务端配置"></a>调整服务端配置</h4><p>Eureka 注册中心地址存储在 <code>ApolloConfigDB.ServerConfig</code> 表中，如下图，在③Value的地方添加多个地址即可。</p>
<p><img src="apollo-72.png" alt></p>
<h4 id="配置-apollo-portal-的-meta-service-信息"><a href="#配置-apollo-portal-的-meta-service-信息" class="headerlink" title="配置 apollo-portal 的 meta service 信息"></a>配置 apollo-portal 的 meta service 信息</h4><p>Apollo Portal 需要在不同的环境访问不同的 meta service(apollo-configservice) 地址，所以我们需要在配置中提供这些信息。默认情况下，meta service 和 config service 是部署在同一个JVM进程，所以 meta service 的地址就是 config service 的地址。</p>
<blockquote>
<p>对于 1.6.0 及以上版本，可以通过 ApolloPortalDB.ServerConfig 中的配置项来配置 Meta Service 地址。</p>
</blockquote>
<h5 id="新版本配置方式-1"><a href="#新版本配置方式-1" class="headerlink" title="新版本配置方式"></a>新版本配置方式</h5><p>通过 <code>apollo.portal.meta.servers</code> 添加 meta service(apollo-configservice) 地址，类似以下方式，修改完需要重启生效。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"DEV"</span>:<span class="string">"http://101.133.158.45:8080"</span>,</span><br><span class="line"> 	<span class="attr">"PRO"</span>:<span class="string">"http://101.43.13.48:8080,http://101.43.13.49:8080"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="apollo-73.png" alt></p>
<h5 id="旧版本配置方式-1"><a href="#旧版本配置方式-1" class="headerlink" title="旧版本配置方式"></a>旧版本配置方式</h5><p>打开<code>apollo-portal-x.x.x-github.zip</code>中<code>config</code>目录下的<code>apollo-env.properties</code>文件。</p>
<p>假设 <code>DEV</code> 的 <code>apollo-configservice</code> 未绑定域名，地址是 <code>1.1.1.1:8080</code>，<code>FAT</code> 的 <code>apollo-configservice</code> 绑定了域名 <code>apollo.fat.xxx.com</code>，<code>UAT</code> 的 <code>apollo-configservice</code> 绑定了域名 <code>apollo.uat.xxx.com</code>，<code>PRO</code> 的 <code>apollo-configservice</code> 绑定了域名 <code>apollo.xxx.com</code>，那么可以如下修改各环境 <code>meta service</code> 服务地址，格式为<code>${env}.meta=http://${config-service-url:port}</code>，如果某个环境不需要，也可以直接删除对应的配置项，参考案例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dev.meta=http://1.1.1.1:8080</span><br><span class="line">fat.meta=http://apollo.fat.xxx.com</span><br><span class="line">uat.meta=http://apollo.uat.xxx.com</span><br><span class="line">pro.meta=http://apollo.xxx.com</span><br></pre></td></tr></table></figure>

<p>如果采用旧版本配置方式，本小节配置方案如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#local.meta=http://localhost:8080</span><br><span class="line">dev.meta=http://101.133.158.45:8080</span><br><span class="line">#fat.meta=http://fill-in-fat-meta-server:8080</span><br><span class="line">#uat.meta=http://fill-in-uat-meta-server:8080</span><br><span class="line">#lpt.meta=$&#123;lpt_meta&#125;</span><br><span class="line">pro.meta=http://101.43.13.48:8080,http://101.43.13.49:8080</span><br></pre></td></tr></table></figure>

<blockquote>
<p>除了通过<code>apollo-env.properties</code>方式配置 meta service 以外，apollo 也支持在运行时指定 meta service（优先级比<code>apollo-env.properties</code>高）：</p>
<p><strong>通过 Java System Property</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; $&#123;env&#125;_meta</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ul>
<li>可以通过 Java 的 System Property <code>${env}_meta</code>来指定</li>
<li>如<code>java -Ddev_meta=http://config-service-url -jar xxx.jar</code></li>
<li>也可以通过程序指定，如<code>System.setProperty(&quot;dev_meta&quot;, &quot;http://config-service-url&quot;);</code></li>
</ul>
<p><strong>通过操作系统的 System Environment</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; $&#123;ENV&#125;_META</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ul>
<li>如<code>DEV_META=http://config-service-url</code></li>
<li>注意 key 为全大写，且中间是<code>_</code>分隔</li>
</ul>
</blockquote>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><p>安装服务器都进入对应安装包的 <code>script</code> 目录，执行 <code>startup.sh</code> 文件。</p>
<p>启动顺序为</p>
<ul>
<li>101.133.158.45 首先启动 Portal，然后启动ConfigService 再启动 AdminService</li>
<li>101.43.13.48 启动 ConfigService 再启动 AdminService</li>
<li>101.43.13.49 启动 ConfigService 再启动 AdminService</li>
</ul>
<p>访问：<a href="http://101.43.13.48:8080" target="_blank" rel="noopener">http://101.43.13.48:8080</a> 和 <a href="http://101.43.13.49:8080" target="_blank" rel="noopener">http://101.43.13.49:8080</a> 看看 Eureka 以及各服务是否正常启动。</p>
<h2 id="15-灰度发布"><a href="#15-灰度发布" class="headerlink" title="15. 灰度发布"></a>15. 灰度发布</h2><p>在一般情况下，升级服务器端应用，需要将应用源码或程序包上传到服务器，然后停止掉老版本服务，再启动新版本。但是这种简单的发布方式存在两个问题，一方面，在新版本升级过程中，服务是暂时中断的，另一方面，如果新版本有BUG，升级失败，回滚起来也非常麻烦，容易造成更长时间的服务不可用。</p>
<p>为了解决这些问题，人们研究出了多种发布策略，比如蓝绿部署、滚动发布、灰度发布等，Apollo 采用的是灰度发布的特性。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><img src="apollo-74.jpg" alt></p>
<blockquote>
<p>灰度发布也叫<strong>金丝雀发布</strong>，起源是，矿井工人发现，金丝雀对瓦斯气体很敏感，矿工会在下井之前，先放一只金丝雀到井中，如果金丝雀不叫了，就代表瓦斯浓度高。</p>
</blockquote>
<p>在灰度发布开始后，先启动一个新版本应用，但是并不直接将流量切过来，而是测试人员对新版本进行线上测试，启动的这个新版本应用，就是我们的金丝雀。如果没有问题，那么可以将少量的用户流量导入到新版本上，然后再对新版本做运行状态观察，收集各种运行时数据，如果此时对新旧版本做各种数据对比，就是所谓的 A/B 测试。</p>
<p>当确认新版本运行良好后，再逐步将更多的流量导入到新版本上，在此期间，还可以不断地调整新旧两个版本的运行的服务器副本数量，以使得新版本能够承受越来越大的流量压力。直到将100%的流量都切换到新版本上，最后关闭剩下的老版本服务，完成灰度发布。如果在灰度发布过程中（灰度期）发现了新版本有问题，就应该立即将流量切回老版本上，这样，就会将负面影响控制在最小范围内。</p>
<h3 id="实践-1"><a href="#实践-1" class="headerlink" title="实践"></a>实践</h3><p>使用 <code>spring-cloud-demo-apollo-config</code> 中的 <code>order-service03</code> 和 <code>order-service04</code> 两个实例来实践，<code>order-service03</code> 在 Windows 端运行，<code>order-service04</code> 在 Linux 端运行。</p>
<h4 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h4><p><code>order-service03</code>的配置文件。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9093</span>  <span class="comment"># 端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">order-service</span>  <span class="comment"># 应用名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apollo相关配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必选配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line">  <span class="comment">#id: order-service  # 与Apollo配置中心中的AppId一致</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">demo-service</span>  <span class="comment"># 与Apollo配置中心中的AppId一致</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apollo:</span></span><br><span class="line"><span class="attr">  meta:</span> <span class="attr">http://192.168.0.195:8080</span>  <span class="comment"># Apollo 中的 Eureka 注册中心地址</span></span><br><span class="line"><span class="comment"># 可选配置</span></span><br><span class="line"><span class="attr">  cluster:</span> <span class="string">SHAOY</span>  <span class="comment"># 指定 Apollo 集群，相同集群实例使用对应集群的配置</span></span><br><span class="line">  <span class="comment">#cacheDir:  # 配置缓存目录，网络不可用时任然可提供配置服务</span></span><br><span class="line"><span class="attr">  bootstrap:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">DEV</span>  <span class="comment"># env支持以下几个值（大小写不敏感）：DEV/FAT/UAT/PRO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">order-service-dev</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<p><code>order-service04</code>的配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9094</span>  <span class="comment"># 端口</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">order-service</span>  <span class="comment"># 应用名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apollo相关配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 必选配置</span></span><br><span class="line"><span class="attr">app:</span></span><br><span class="line">  <span class="comment">#id: order-service  # 与Apollo配置中心中的AppId一致</span></span><br><span class="line"><span class="attr">  id:</span> <span class="string">demo-service</span>  <span class="comment"># 与Apollo配置中心中的AppId一致</span></span><br><span class="line"><span class="attr">apollo:</span></span><br><span class="line"><span class="attr">  meta:</span> <span class="attr">http://192.168.0.195:8080</span>  <span class="comment"># Apollo 中的 Eureka 注册中心地址</span></span><br><span class="line"><span class="comment"># 可选配置</span></span><br><span class="line">  <span class="comment">#cluster:    # 指定 Apollo 集群，相同集群实例使用对应集群的配置</span></span><br><span class="line">  <span class="comment">#cacheDir:  # 配置缓存目录，网络不可用时任然可提供配置服务</span></span><br><span class="line"><span class="attr">  bootstrap:</span></span><br><span class="line"><span class="attr">    enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">DEV</span>  <span class="comment"># env支持以下几个值（大小写不敏感）：DEV/FAT/UAT/PRO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">order-service-dev</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<p>最终效果如下：</p>
<p><img src="apollo-74.png" alt></p>
<h4 id="创建灰度"><a href="#创建灰度" class="headerlink" title="创建灰度"></a>创建灰度</h4><p>点击右上角<code>灰度</code>按钮，点击确定创建灰度。</p>
<p><img src="apollo-75.png" alt></p>
<p><img src="apollo-76.png" alt></p>
<h4 id="新增灰度配置"><a href="#新增灰度配置" class="headerlink" title="新增灰度配置"></a>新增灰度配置</h4><p><img src="apollo-77.png" alt></p>
<p><img src="apollo-78.png" alt></p>
<h4 id="新增灰度规则"><a href="#新增灰度规则" class="headerlink" title="新增灰度规则"></a>新增灰度规则</h4><p><img src="apollo-79.png" alt></p>
<p><img src="apollo-80.png" alt></p>
<h4 id="灰度发布"><a href="#灰度发布" class="headerlink" title="灰度发布"></a>灰度发布</h4><p><img src="apollo-81.png" alt></p>
<h4 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h4><p>访问<a href="http://192.168.237.1:9093/name，结果如下图所示：" target="_blank" rel="noopener">http://192.168.237.1:9093/name，结果如下图所示：</a></p>
<p><img src="apollo-82.png" alt></p>
<p>访问<a href="http://192.168.237.1:9093/name，结果如下图所示：" target="_blank" rel="noopener">http://192.168.237.1:9093/name，结果如下图所示：</a></p>
<p><img src="apollo-83.png" alt></p>
<h4 id="放弃灰度"><a href="#放弃灰度" class="headerlink" title="放弃灰度"></a>放弃灰度</h4><p>确认放弃灰度以后会删除该灰度版本，并恢复为主版本的配置信息。</p>
<p><img src="apollo-84.png" alt></p>
<h4 id="全量发布"><a href="#全量发布" class="headerlink" title="全量发布"></a>全量发布</h4><p>全量发布将会把灰度版本的配置合并到主分支，并发布。</p>
<p><img src="apollo-85.png" alt></p>
<h4 id="发布历史"><a href="#发布历史" class="headerlink" title="发布历史"></a>发布历史</h4><p>可以通过<code>发布历史</code>来查看所有的发布记录，比如主版本发布，主版本回滚，灰度操作、灰度规则等等。</p>
<p><img src="apollo-86.png" alt></p>
<p>至此 Apollo 配置中心所有的知识点就学习结束了。</p>
<hr>
<p>参考资料：<br><a href="https://mrhelloworld.com/apollo/" target="_blank" rel="noopener">Spring Cloud 系列之 Apollo 配置中心 - 哈喽沃德先生 (mrhelloworld.com)</a></p>
	
	</div>
	
	<div id="current-post-cover" data-scr="/img/post_cover/spring-cloud-apollo.jpg"></div>

	<!-- relate post, comment...-->
	<div class="investment-container">
		<div class="investment-header">
			<div class="investment-title-1">
				<div class="on">相关文章</div>
				<div>评论</div>
				<div>分享</div>
			</div>
			<div class="investment-title-2">	            
				
	<span>
		<a href="javascript: window.scrollTo(0, 0);">返回顶部</a>
		
			<a href="/2023/09/09/Java并发编程（四）-共享模型之无锁/" title="Java并发编程（四）-共享模型之无锁" rel="prev">
				&laquo;上一篇
			</a>
		
		
			<a href="/2022/06/29/Spring-Cloud-Consul配置中心/" title="Spring Cloud Consul配置中心" rel="next">
				下一篇&raquo;
			</a>
			
	</span>


      		
			</div>	
		</div>
		
		<div class="investment-content">
			<div class="investment-content-list">
				

<div class="relate-post">
	
		<ul>
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2022/06/29/Spring-Cloud-Consul配置中心/" title="Spring Cloud Consul配置中心">
								Spring Cloud Consul配置中心			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 29日, 2022				
							</p>
							<p class="relate-post-content">
								Spring Cloud Consul配置中心之前学习过了Spring Cloud Config，它提供了配置中心的功能，但是需要配合git、svn或外部存储（例如各种数据库），而且需要配合Spring Cloud Bus实现配置刷新...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2022/06/29/Spring-Cloud-Consul配置中心/" title="Spring Cloud Consul配置中心">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/spring-cloud-consul.png" alt="Spring Cloud Consul配置中心"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2022/06/28/Spring-Cloud之Bus消息总线/" title="Spring Cloud之Bus消息总线">
								Spring Cloud之Bus消息总线			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 28日, 2022				
							</p>
							<p class="relate-post-content">
								Spring Cloud之Bus消息总线1. 消息代理消息代理(Message Broker)是一种消息验证、传输、路由的架构模式。它在应用程序之间起到通信调度并最小化应用之间的依赖的作用，使得应用程序可以高效地解耦通信过程。消息代理...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2022/06/28/Spring-Cloud之Bus消息总线/" title="Spring Cloud之Bus消息总线">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/spring-cloud-bus.jpg" alt="Spring Cloud之Bus消息总线"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2022/06/25/Spring-Cloud之Config配置中心/" title="Spring Cloud之Config配置中心">
								Spring Cloud之Config配置中心			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 25日, 2022				
							</p>
							<p class="relate-post-content">
								Spring Cloud之Config配置中心1. 服务配置现状随着微服务系统的不断迭代，整个我服务就成为了一个网状结构，这个时候就要考虑整个微服务系统的扩展性、伸缩性、耦合性等等。其中一个重要的环节就是配置管理的问题。
2. 常规配...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2022/06/25/Spring-Cloud之Config配置中心/" title="Spring Cloud之Config配置中心">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/spring-cloud-config.jpg" alt="Spring Cloud之Config配置中心"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2022/06/21/Spring-Cloud之Stream消息驱动/" title="Spring Cloud之Stream消息驱动">
								Spring Cloud之Stream消息驱动			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 21日, 2022				
							</p>
							<p class="relate-post-content">
								Spring Cloud之Stream消息驱动在实际的企业开发中，消息中间件是至关重要的组件之一。消息中间件主要解决应用解耦，异步消息，流量削锋等问题，实现高性能，高可用，可伸缩和最终一致性架构。
不同的中间件其实现方式，内部结构是不...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2022/06/21/Spring-Cloud之Stream消息驱动/" title="Spring Cloud之Stream消息驱动">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/spring-cloud-stream.jpg" alt="Spring Cloud之Stream消息驱动"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2022/06/09/Spring-Cloud之Sleuth链路追踪/" title="Spring Cloud之Sleuth链路追踪">
								Spring Cloud之Sleuth链路追踪			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 9日, 2022				
							</p>
							<p class="relate-post-content">
								Spring Cloud之Sleuth链路追踪1. 问题随着微服务架构的流行，服务按照不同的维度进行拆分，一次请求往往需要涉及到多个服务。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2022/06/09/Spring-Cloud之Sleuth链路追踪/" title="Spring Cloud之Sleuth链路追踪">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/spring-cloud-sleuth.jpg" alt="Spring Cloud之Sleuth链路追踪"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2021/09/03/Spring-Cloud之Netflix-Zuul服务网关/" title="Spring Cloud之Netflix Zuul服务网关">
								Spring Cloud之Netflix Zuul服务网关			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								九月 3日, 2021				
							</p>
							<p class="relate-post-content">
								Spring Cloud之Netflix Zuul服务网关1. 什么是服务网关?API Gateway（API GW / API 网关），顾名思义，是出现在系统边界上的一个面向 API 的、串行集中式的强管控服务，这里的边界是企业 I...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2021/09/03/Spring-Cloud之Netflix-Zuul服务网关/" title="Spring Cloud之Netflix Zuul服务网关">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/cover_zuul.jpg" alt="Spring Cloud之Netflix Zuul服务网关"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2021/09/01/Spring-Cloud之Consul-服务注册中心/" title="Spring Cloud之Consul 服务注册中心">
								Spring Cloud之Consul 服务注册中心			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								九月 1日, 2021				
							</p>
							<p class="relate-post-content">
								Spring Cloud之Consul 服务注册中心1.什么是Consul?Consul 是 HashiCorp 公司推出的开源产品，是一种服务网格(Service Mesh)解决方案。用于实现分布式系统的服务发现、服务隔离、服务配置...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2021/09/01/Spring-Cloud之Consul-服务注册中心/" title="Spring Cloud之Consul 服务注册中心">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/cover_consul.jpg" alt="Spring Cloud之Consul 服务注册中心"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/06/22/hello-world/" title="Hello World">
								Hello World			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 22日, 2024				
							</p>
							<p class="relate-post-content">
								一切始于Hello World!

							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/06/22/hello-world/" title="Hello World">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/HelloWorld.jpeg" alt="Hello World"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2024/06/16/Java并发编程（五）-共享模型之不可变/" title="Java并发编程（五）-共享模型之不可变">
								Java并发编程（五）-共享模型之不可变			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								六月 16日, 2024				
							</p>
							<p class="relate-post-content">
								本章内容

不可变类使用
不可变类设计
无状态类设计1. 日期转换的问题问题提出下面的代码在运行时，由于 SimpleDateFormat 不是线程安全的。12345678910SimpleDateFormat sdf = new S...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2024/06/16/Java并发编程（五）-共享模型之不可变/" title="Java并发编程（五）-共享模型之不可变">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/java_concurrency05.jpg" alt="Java并发编程（五）-共享模型之不可变"/>
							</a>
						</div>
					</li>											
			
			
					<li>
						<div class="relate-post-text">
							<a class="relate-post-title" href="/2023/09/09/Java并发编程（四）-共享模型之无锁/" title="Java并发编程（四）-共享模型之无锁">
								Java并发编程（四）-共享模型之无锁			
							</a>
							<p class="relate-post-date">
								<i class="fa fa-calendar"></i>
								九月 9日, 2023				
							</p>
							<p class="relate-post-content">
								本章内容

CAS 与 volatile
原子整数
原子引用
原子累加器
Unsafe

1. 问题提出有如下需求，保证 account.withdraw 取款方法的线程安全
12345678910111213141516171819...
							</p>
						</div>

						<div class="relate-post-cover">
							<a href="/2023/09/09/Java并发编程（四）-共享模型之无锁/" title="Java并发编程（四）-共享模型之无锁">				
								
								<img class="lazy" src="/img/placeholder.jpg" data-src="/img/post_cover/java_concurrency04.jpg" alt="Java并发编程（四）-共享模型之无锁"/>
							</a>
						</div>
					</li>											
			
			
		</ul>
	
</div>	
			</div>
			<div class="investment-content-list">
				<div class="layout-comment">

	

		

			<!-- gitalk comment -->
			<!-- show gitalk comment -->
<div id="gitalk-container"></div>

<!-- gitalk`s css & js -->
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<link rel="stylesheet" href="/css/comment.css">
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script type="text/javascript">
	//Thanks O-R
	//https://github.com/gitalk/gitalk/issues/102#issuecomment-382970552
	//去除尾部匹配正则数组的字符串  
	//Remove redundant characters
	String.prototype.trimEnd = function(regStr) {
		var result = this;
		if(regStr == undefined || regStr == null || regStr == "") {
			return result;
		}
		var array = regStr.split(',');

		if(array.length > 0) {

			var c = array.shift();
			var str = this;
			var i = str.length;
			var rg = new RegExp(c);
			var matchArr = str.match(rg);

			if(matchArr != undefined && matchArr != null && matchArr.length > 0) {
				var matchStr = matchArr[0].replace(/\\/g, "\\\\").replace(/\*/g, "\\*")
					.replace(/\+/g, "\\+").replace(/\|/g, "\\|")
					.replace(/\{/g, "\\{").replace(/\}/g, "\\}")
					.replace(/\(/g, "\\(").replace(/\)/g, "\\)")
					.replace(/\^/g, "\\^").replace(/\$/g, "\\$")
					.replace(/\[/g, "\\[").replace(/\]/g, "\\]")
					.replace(/\?/g, "\\?").replace(/\,/g, "\\,")
					.replace(/\./g, "\\.").replace(/\&/g, "\\&");
				matchStr = matchStr + '$';
				result = str.replace(new RegExp(matchStr), "");
			}

			if(array.length > 0) {
				return result.trimEnd(array.join())
			} else {
				return result;
			}
		}
	};

	//Create gitalk
	var gitalk = new Gitalk({
		clientID: '36a5ea1eb92d0cdb0a6b',
		clientSecret: '6e1940c0dcd00e3b9216f008368995a1988bd3fd',
		//id: window.location.pathname,
		//id: decodeURI(window.location.pathname),
		//id: (window.location.pathname).split("/").pop().substring(0, 49),
		id: decodeURI( md5( location.href.trimEnd('#.*$,\\?.*$,index.html$') ) ),
		repo: 'Blog-Comment-Repo',
		owner: '10veU',
		admin: '10veU',
		distractionFreeMode: 'true',
	})
	gitalk.render('gitalk-container');
</script>

		
		
	

</div>
			</div>
			<div class="investment-content-list">
				<div class="layout-share">
	
	

		
			
			<!-- socialShare share -->
			<div class="social-share"></div>

<!--  css & js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script async src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
			
		
		
	
</div>


			</div>
		</div>	
	</div>
	</div>
</div>



	<!-- leancloud -->
	<!--
	时间：2018-11-27
	描述：
		文章访问量：visitors
		文章喜欢量：likes	
		文章排行榜：topNPost
		其他得说明：
			01-Cookie相关的函数 
				https://blog.csdn.net/somehow1002/article/details/78511541（Author：somehow1002）
			02-visitors相关的函数 
				https://blog.csdn.net/u013553529/article/details/63357382（Author：爱博客大伯）
				https://notes.doublemine.me/2015-10-21-为NexT主题添加文章阅读量统计功能.html（Author：夏末）
			03-topNPost相关的函数
				https://hoxis.github.io/hexo-next-read-rank.html（Author：hoxis）
			04-likes相关的函数，
				参考了01 & 02进行简单的设计与实现
-->



	<script>
		var appid = 'xjORdBJdoaL0hhncjL9HJTJN-MdYXbMMI',
            appkey = 'Tkq82uGKwAFYHPeTF3Q6MVDp';	  
        AnnieLeancloud(appid, appkey);         
	</script>
    

	


<!-- show math formula -->



	 
	<script src="/plugin/clipboard/clipboard.js"></script>
	<script>
		// Copy code !
	    function codePreprocessing() {
	        $("#article-content .highlight").each(function() {

	            $(this).wrap('<div id="post-code"></div>');

	        })

	        $("#article-content #post-code").each(function() {

	            $(this).prepend('<nav class="copy-nav"><span><i class="code-language"></i></span></nav>');

	        })

	        $("#article-content .copy-nav").each(function() {
	            var temp = $(this).next().attr('class'),
	                language = ((temp.length > 9) && (temp != null)) ? temp.substr(10) : "none"; //why 9? Need to check language?

	            $(this).find('.code-language').text(language);

	            $(this).append('<span class="copy-btn"><i class="fa fa-copy" aria-hidden="true"></i></span>');

	        });
	    }

		function codeCopy() {
		    $('#article-content #post-code').each(function(i) {
		        var codeCopyId = 'codeCopy-' + i;

		        var codeNode = $(this).find('.code'),
		            copyButton = $(this).find('.copy-btn');

		        codeNode.attr('id', codeCopyId);
		        copyButton.attr('data-clipboard-target-id', codeCopyId);
		    })

		    
			var clipboard = new ClipboardJS('.copy-btn', {
					target: function(trigger) {
						return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
					}
		      	});

			//pure js
			function showTooltip(elem, msg) {		   
				elem.setAttribute('aria-label', msg);
				elem.setAttribute('class', 'copy-btn copy-status');
				setTimeout(function() {
					elem.setAttribute('class', 'copy-btn');
				}, 2000);
			}

			clipboard.on('success', function(e) {
			    e.clearSelection();
			    console.info('Action:', e.action);		   
			    console.info('Trigger:', e.trigger);
			    showTooltip(e.trigger, 'Copied!');
			    
			});
			clipboard.on('error', function(e) {
			    console.error('Action:', e.action);
			    console.error('Trigger:', e.trigger);
			});
		

		}

		if ($('.layout-post').length) {
		    codePreprocessing();
		    codeCopy();
		} 
	</script>





<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
<script src="/plugin/fancybox/jquery.fancybox.js"></script>

<script type="text/javascript">
	var titleID = $('.article-title a'),
		imageID = $('.article-content img'),
		videoID = $('.article-content video');

	var postTitle = titleID.text() ? titleID.text() : "No post title!";

	imageID.each(function() {
		var imgPath = $(this).attr('src'),
			imgTitle = $(this).attr('alt') ? $(this).attr('alt') : "No image description!";

		//给每个匹配的<img>元素打包, 即添加父元素<a>
		$(this).wrap('<a data-fancybox="gallery" data-caption=" 《 ' + postTitle + ' 》 ' + imgTitle + ' "  href=" ' + imgPath + ' "> </a>');
	});

	videoID.each(function() {
		var videoPath = $(this).attr('src');

		//给每个匹配的<img>元素打包, 即添加父元素<a>
		$(this).wrap('<a data-fancybox href=" ' + videoPath + ' "> </a>');
	});
	//TODO：支持html5 video

	if($('#layout-post').length) {
		$('[data-fancybox="gallery"]').fancybox({
			loop: true,
			buttons: [
				"zoom",
				"share",
				"slideShow",
				"fullScreen",
				//"download",
				"thumbs",
				"close"
			],
			protect: false
		});
	}
</script>
		</main>

		<!--footer-->
		<footer>
	<div class="social">
		<ul>
	
		<li>
			<a href="https://github.com/10veU" target="_blank">
				<i class="fa fa-github"></i>
			</a>
		</li>
	
		<li>
			<a href="https://weibo.com/5559797464/profile?rightmod=1&wvr=6&mod=personinfo&is_all=1" target="_blank">
				<i class="fa fa-weibo"></i>
			</a>
		</li>
	
		<li>
			<a href="/img/wechat.jpg" target="_blank">
				<i class="fa fa-wechat"></i>
			</a>
		</li>
	
		<li>
			<a href="tencent://message/?menu=yes&uin=514084647&websitename=im.qq.com" target="_blank">
				<i class="fa fa-qq"></i>
			</a>
		</li>
	
		<li>
			<a href="mailto:xiaojie_wangxj@163.com" target="_blank">
				<i class="fa fa-envelope"></i>
			</a>
		</li>
	
		<li>
			<a href="/atom.xml" target="_blank">
				<i class="fa fa-rss"></i>
			</a>
		</li>
			
</ul>

	</div>
	<div class="copyright">
		<p>
			 
				&copy;2019 - 2024, content by XiaoJie Wang. All Rights Reserved.
			
			
			

	<!-- busuanzi -->
	<!-- busuanzi -->

		
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	

		<span id="busuanzi_container_page_pv">
	  		本文总阅读量<span id="busuanzi_value_page_pv"></span>次
		</span>

	




		</p>
		<p>
			<a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> Theme <a href="https://github.com/Sariay/hexo-theme-Annie" title="Annie" target="_blank" rel="noopener">Annie</a> by Sariay.
			<a href="javascript:zh_tran('s');" class="zh_click" id="zh_click_s">简体</a> 
			<a href="javascript:zh_tran('t');" class="zh_click" id="zh_click_t">繁體</a>				
		</p>
	</div>	
</footer>
		
	<!-- set '1' to show motto in all pages! -->

	<script src="/plugin/motto/motto.js"></script>
	
	<script type="text/javascript">
		$(".motto").html( getMingYanContent() );
	</script>	




	<!--
	时间：2018-10-3
	描述：
		插件名称：hexo-generator-search-zip
		插件来源: https://github.com/SuperKieran/hexo-generator-search-zip
		代码参考：https://github.com/SuperKieran/TKL/blob/master/layout/_partial/search.ejs(Include: js & css)	
-->
<div class="popup search-popup local-search-popup" >
	<div class="local-search-container">
		<span class="popup-btn-close">
      		ESC
   		</span>
		<div class="local-search-header">
			<div class="input-prompt">				
			</div>
			<input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
		</div>
		<div class="local-search-body">
			<div id="local-search-output"></div>
		</div>
		<div class="local-search-footer">
			<div class="topN-post">				
				

   
	<div id="topN">
		<div class="topN-title" data-title= "热门文章"></div> 
	</div>
	
    <script>
        var appid = 'xjORdBJdoaL0hhncjL9HJTJN-MdYXbMMI',
            appkey = 'Tkq82uGKwAFYHPeTF3Q6MVDp',
            limitCount = 10;
        if( $('#topN').length ){
            AV.initialize(appid, appkey);
            var Counter = AV.Object.extend("Counter");  
            topNPost(Counter, limitCount);
        }
    </script>
   
								
			</div>
		</div>
	</div>
</div>

<script src="/plugin/search/ziploader.js"></script>
<script src="/plugin/search/search.js"></script>

<script type="text/javascript">
	var search_path = 'search.json',
		zip_Path = '/search.zip',
		version_Path = '/searchVersion.txt',
		input_Trigger = 'auto',
		top_N = '2';

	themeLocalSearch({
		search_path, 
		zip_Path, 
		version_Path, 
		input_Trigger, 
		top_N
	});
</script>


<!-- love effect -->

<!-- firework effect -->

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
	<script src="/plugin/love/fireworks.js"></script>

<!--daovoice-->

	<script src="/plugin/daovoice/daovoice.js"></script>

<!-- back to top -->

	
	<div id="totop">
  		<a href="javascript:;"  name="TOTOP" class="fa fa-arrow-up" ></a>
	</div>



<!-- site analysis -->


	<!-- site-analysis -->
	
<script>
	var _hmt = _hmt || [];
	(function() {
		var hm = document.createElement("script");
		hm.src = "//hm.baidu.com/hm.js?bc5394d96eab6c50c0a37cb03555fc96";
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(hm, s);
	})();
</script>

	
	
	
	
 

<script src="/plugin/vibrant/vibrant.js"></script>
<script src="/plugin/chinese/chinese.js"></script>
<script src="/plugin/imgLazyLoader/yall.min.js"></script>
<script src="/plugin/imgResize/jquery.resizeimagetoparent.min.js"></script>
<script src="/plugin/nicescroll/jquery.nicescroll.js"></script>
<script src="/js/resizediv.js"></script>
<script src="/js/main.js"></script>
	</body>	
</html>